<!DOCTYPE html>
<html>
<head>
  <title>SeaScreen Screensaver</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      cursor: none; /* Hide cursor */
    }
    video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <video id="videoPlayer" autoplay muted></video>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const videoPlayer = document.getElementById("videoPlayer");
      let videoQueue = [];
      let playedVideos = [];
      let settingsOpen = false;
      let exitAllowed = false;

      try {
        console.log("‚úÖ screensaver.html loaded. Requesting video files...");
        const videoFiles = await window.electronAPI.invoke("get-video-files");
        console.log("üé• Video files retrieved:", videoFiles);

        if (videoFiles.length === 0) {
          console.error("‚ùå No videos found.");
          return;
        }

        const shuffleVideos = () => {
          let remainingVideos = videoFiles.filter(file => !playedVideos.includes(file));
          if (remainingVideos.length === 0) {
            playedVideos = [];
            remainingVideos = [...videoFiles];
          }
          videoQueue = remainingVideos.sort(() => Math.random() - 0.5);
        };

        const playNextVideo = () => {
          if (videoQueue.length === 0) shuffleVideos();
          const nextVideo = videoQueue.shift();
          playedVideos.push(nextVideo);
          if (playedVideos.length > 4) playedVideos.shift();
          console.log(`‚ñ∂Ô∏è Playing: ${nextVideo}`);
          videoPlayer.src = `file://${nextVideo}`;
          videoPlayer.load();

          videoPlayer.oncanplay = () => {
            setTimeout(() => {
              console.log("‚úÖ Video loaded, playing...");
              videoPlayer.play().catch(err => console.error("‚ö†Ô∏è Playback error:", err));
            }, 500);
          };
        };

        videoPlayer.addEventListener("ended", playNextVideo);
        videoPlayer.addEventListener("error", () => {
          console.error("‚ùå Video playback error, skipping...");
          playNextVideo();
        });

        shuffleVideos();
        playNextVideo();

        // Enable exit logic **only after the video has started playing**
        videoPlayer.onplay = () => {
          console.log("üîì Exit enabled after video playback starts.");
          exitAllowed = true;
        };

        const exitScreensaver = (event) => {
          if (!exitAllowed) {
            console.log("üö´ Exit attempt blocked (video not started).");
            return;
          }
          if (settingsOpen) {
            console.log("‚öôÔ∏è Settings window open, ignoring exit event.");
            return;
          }
          console.log(`üîç Exit triggered by: ${event.type}`);
          window.electronAPI.send("exit-screensaver");
        };

        // Attach exit listeners for user activity (but ignore if settings is open)
        ["mousemove", "mousedown", "wheel", "keydown"].forEach(eventType => {
          document.addEventListener(eventType, exitScreensaver, { passive: true });
        });

        // **Settings window handling**
        window.electronAPI.on("settings-opened", () => {
          console.log("‚öôÔ∏è Settings window opened. Pausing exit detection.");
          settingsOpen = true;
        });

        window.electronAPI.on("settings-closed", () => {
          console.log("‚öôÔ∏è Settings window closed. Resuming exit detection.");
          setTimeout(() => { settingsOpen = false; }, 500);
        });

      } catch (err) {
        console.error("‚ùå Error loading video files:", err);
      }
    });
  </script>
</body>
</html>